<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Laporan Pekerjaan Mingguan</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jsPDF via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Generator Laporan Pekerjaan Mingguan</h1>
        <form id="laporanForm">
            <!-- Input untuk Logo Header -->
            <div class="mb-3">
                <label for="logoFile" class="form-label">Upload Logo Header (image_logo.png atau gambar lain)</label>
                <input type="file" class="form-control" id="logoFile" accept="image/*">
                <small class="form-text text-muted">Logo ini akan ditambahkan di bagian atas setiap halaman PDF.</small>
            </div>

            <!-- Header Laporan -->
            <div class="mb-3">
                <label for="posisi" class="form-label">Posisi</label>
                <input type="text" class="form-control" id="posisi" value="Web Programmer" required>
            </div>
            <div class="mb-3">
                <label for="periode" class="form-label">Periode Laporan</label>
                <input type="text" class="form-control" id="periode" placeholder="Contoh: 18 Agustus 2025 – 23 Agustus 2025" required>
            </div>
            <div class="mb-3">
                <label for="proyek" class="form-label">Proyek</label>
                <input type="text" class="form-control" id="proyek" placeholder="Contoh: Pengembangan Sistem Pendaftaran dan Pemenuhan Data" required>
            </div>

            <!-- Pendahuluan -->
            <div class="mb-3">
                <label for="pendahuluan" class="form-label">1. Pendahuluan</label>
                <textarea class="form-control" id="pendahuluan" rows="3" required></textarea>
            </div>

            <!-- Pekerjaan yang Telah Dilakukan (Dynamic) -->
            <div class="mb-3">
                <h5>2. Pekerjaan yang Telah Dilakukan</h5>
                <div id="pekerjaanSections"></div>
                <button type="button" class="btn btn-secondary" id="addPekerjaan">Tambah Pekerjaan</button>
            </div>

            <!-- Kendala -->
            <div class="mb-3">
                <label for="kendala" class="form-label">3. Kendala yang Dihadapi</label>
                <textarea class="form-control" id="kendala" rows="3" required></textarea>
            </div>

            <!-- Rencana Tindak Lanjut -->
            <div class="mb-3">
                <label for="rencana" class="form-label">4. Rencana Tindak Lanjut</label>
                <textarea class="form-control" id="rencana" rows="3" required></textarea>
            </div>

            <!-- Kesimpulan -->
            <div class="mb-3">
                <label for="kesimpulan" class="form-label">5. Kesimpulan</label>
                <textarea class="form-control" id="kesimpulan" rows="3" required></textarea>
            </div>

            <!-- Lampiran Gambar (Dynamic) -->
            <div class="mb-3">
                <h5>Lampiran Gambar</h5>
                <div id="gambarSections"></div>
                <button type="button" class="btn btn-secondary" id="addGambar">Tambah Gambar</button>
            </div>

            <!-- Tombol Generate -->
            <button type="button" class="btn btn-primary" id="generatePDF">Generate PDF</button>
            <button type="button" class="btn btn-primary ms-2" id="generateDOCX">Generate DOCX (Experimental)</button>
        </form>
    </div>

    <!-- Bootstrap JS via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- docxtemplater dan PizZip untuk DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.30.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PizZip/3.1.3/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Fungsi untuk menyimpan data ke localStorage
        function saveData() {
            const data = {
                posisi: document.getElementById('posisi').value,
                periode: document.getElementById('periode').value,
                proyek: document.getElementById('proyek').value,
                pendahuluan: document.getElementById('pendahuluan').value,
                kendala: document.getElementById('kendala').value,
                rencana: document.getElementById('rencana').value,
                kesimpulan: document.getElementById('kesimpulan').value,
                pekerjaanSections: Array.from(document.querySelectorAll('.pekerjaan-section')).map(section => ({
                    judul: section.querySelector('.judul-pekerjaan').value,
                    tujuan: section.querySelector('.tujuan-pekerjaan').value,
                    deskripsi: section.querySelector('.deskripsi-pekerjaan').value,
                    hasil: section.querySelector('.hasil-pekerjaan').value
                })),
                gambarSections: Array.from(document.querySelectorAll('.gambar-section')).map(section => ({
                    keterangan: section.querySelector('.keterangan-gambar').value
                    // File gambar tidak disimpan di localStorage (hanya keterangan), karena file harus diunggah ulang
                }))
            };
            localStorage.setItem('laporanData', JSON.stringify(data));
        }

        // Fungsi untuk memulihkan data dari localStorage
        function loadData() {
            const data = JSON.parse(localStorage.getItem('laporanData') || '{}');
            if (data) {
                document.getElementById('posisi').value = data.posisi || '';
                document.getElementById('periode').value = data.periode || '';
                document.getElementById('proyek').value = data.proyek || '';
                document.getElementById('pendahuluan').value = data.pendahuluan || '';
                document.getElementById('kendala').value = data.kendala || '';
                document.getElementById('rencana').value = data.rencana || '';
                document.getElementById('kesimpulan').value = data.kesimpulan || '';

                // Memulihkan pekerjaan
                const pekerjaanSections = document.getElementById('pekerjaanSections');
                pekerjaanSections.innerHTML = '';
                if (Array.isArray(data.pekerjaanSections)) {
                    data.pekerjaanSections.forEach((item, index) => {
                        pekerjaanCount++;
                        const section = document.createElement('div');
                        section.classList.add('mb-3', 'border', 'p-3', 'pekerjaan-section');
                        section.innerHTML = `
                            <label class="form-label">2.${pekerjaanCount} Judul Pekerjaan</label>
                            <input type="text" class="form-control mb-2 judul-pekerjaan" value="${item.judul || ''}" required>
                            <label class="form-label">Tujuan</label>
                            <textarea class="form-control mb-2 tujuan-pekerjaan" rows="2" required>${item.tujuan || ''}</textarea>
                            <label class="form-label">Deskripsi Pekerjaan (pisahkan dengan baris baru untuk bullet points)</label>
                            <textarea class="form-control mb-2 deskripsi-pekerjaan" rows="3" required>${item.deskripsi || ''}</textarea>
                            <label class="form-label">Hasil</label>
                            <textarea class="form-control mb-2 hasil-pekerjaan" rows="2" required>${item.hasil || ''}</textarea>
                            <button type="button" class="btn btn-danger btn-sm remove-section">Hapus</button>
                        `;
                        pekerjaanSections.appendChild(section);
                        section.querySelector('.remove-section').addEventListener('click', () => {
                            section.remove();
                            saveData();
                        });
                    });
                }

                // Memulihkan lampiran gambar
                const gambarSections = document.getElementById('gambarSections');
                gambarSections.innerHTML = '';
                if (Array.isArray(data.gambarSections)) {
                    data.gambarSections.forEach((item, index) => {
                        gambarCount++;
                        const section = document.createElement('div');
                        section.classList.add('mb-3', 'border', 'p-3', 'gambar-section');
                        section.innerHTML = `
                            <label class="form-label">Gambar ${gambarCount}</label>
                            <input type="file" class="form-control mb-2 gambar-file" accept="image/*" required>
                            <label class="form-label">Keterangan Gambar</label>
                            <textarea class="form-control mb-2 keterangan-gambar" rows="2" required>${item.keterangan || ''}</textarea>
                            <button type="button" class="btn btn-danger btn-sm remove-section">Hapus</button>
                        `;
                        gambarSections.appendChild(section);
                        section.querySelector('.remove-section').addEventListener('click', () => {
                            section.remove();
                            saveData();
                        });
                    });
                }
            }
        }

        // Inisialisasi variabel counter
        let pekerjaanCount = 0;
        let gambarCount = 0;
        
        // Variabel global untuk menyimpan logo default
        let defaultLogoDataURL = null;

        // Load data saat halaman dimuat
        window.onload = function() {
            // Load logo default saat halaman dimuat
            const loadDefaultLogo = () => {
                return new Promise((resolve) => {
                    const logoImg = new Image();
                    logoImg.src = 'header_logo.png'; // File default di direktori yang sama
                    logoImg.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Gunakan ukuran asli gambar untuk menjaga kualitas
                        canvas.width = logoImg.width;
                        canvas.height = logoImg.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(logoImg, 0, 0); // Gambar tanpa skala paksa
                        // Konversi ke data URL dengan kualitas tinggi
                        defaultLogoDataURL = canvas.toDataURL('image/png', 1.0); // 1.0 untuk kualitas maksimum
                        resolve();
                    };
                    logoImg.onerror = () => {
                        console.error('Gambar default header_logo.png tidak ditemukan!');
                        resolve(); // Lanjutkan meskipun gambar tidak ada
                    };
                });
            };
            // Jalankan load default logo saat halaman dimuat
            loadDefaultLogo().then(() => {
                loadData();

                // Tambahkan event listener untuk menyimpan data saat input berubah
                document.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', saveData);
                });

                // Tambahkan event listener untuk tombol tambah pekerjaan
                document.getElementById('addPekerjaan').addEventListener('click', () => {
                    pekerjaanCount++;
                    const section = document.createElement('div');
                    section.classList.add('mb-3', 'border', 'p-3', 'pekerjaan-section');
                    section.innerHTML = `
                        <label class="form-label">2.${pekerjaanCount} Judul Pekerjaan</label>
                        <input type="text" class="form-control mb-2 judul-pekerjaan" required>
                        <label class="form-label">Tujuan</label>
                        <textarea class="form-control mb-2 tujuan-pekerjaan" rows="2" required></textarea>
                        <label class="form-label">Deskripsi Pekerjaan (pisahkan dengan baris baru untuk bullet points)</label>
                        <textarea class="form-control mb-2 deskripsi-pekerjaan" rows="3" required></textarea>
                        <label class="form-label">Hasil</label>
                        <textarea class="form-control mb-2 hasil-pekerjaan" rows="2" required></textarea>
                        <button type="button" class="btn btn-danger btn-sm remove-section">Hapus</button>
                    `;
                    document.getElementById('pekerjaanSections').appendChild(section);
                    section.querySelector('.remove-section').addEventListener('click', () => {
                        section.remove();
                        saveData();
                    });
                    saveData(); // Simpan setelah menambah section
                });

                // Tambahkan event listener untuk tombol tambah gambar
                document.getElementById('addGambar').addEventListener('click', () => {
                    gambarCount++;
                    const section = document.createElement('div');
                    section.classList.add('mb-3', 'border', 'p-3', 'gambar-section');
                    section.innerHTML = `
                        <label class="form-label">Gambar ${gambarCount}</label>
                        <input type="file" class="form-control mb-2 gambar-file" accept="image/*" required>
                        <label class="form-label">Keterangan Gambar</label>
                        <textarea class="form-control mb-2 keterangan-gambar" rows="2" required></textarea>
                        <button type="button" class="btn btn-danger btn-sm remove-section">Hapus</button>
                    `;
                    document.getElementById('gambarSections').appendChild(section);
                    section.querySelector('.remove-section').addEventListener('click', () => {
                        section.remove();
                        saveData();
                    });
                    saveData(); // Simpan setelah menambah section
                });

                // Fungsi Generate PDF menggunakan jsPDF dengan style baru
                document.getElementById('generatePDF').addEventListener('click', async () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Collect data
                    const posisi = document.getElementById('posisi').value;
                    const periode = document.getElementById('periode').value;
                    const proyek = document.getElementById('proyek').value;
                    const pendahuluan = document.getElementById('pendahuluan').value;
                    const kendala = document.getElementById('kendala').value;
                    const rencana = document.getElementById('rencana').value;
                    const kesimpulan = document.getElementById('kesimpulan').value;

                    // Load logo jika diupload, jika tidak gunakan default
                    let logoDataURL = null;
                    const logoInput = document.getElementById('logoFile');
                    if (logoInput.files.length > 0) {
                        const file = logoInput.files[0];
                        const reader = new FileReader();
                        logoDataURL = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                    } else {
                        logoDataURL = defaultLogoDataURL; // Gunakan logo default jika tidak ada upload
                    }

                    const addHeader = () => {
                        if (logoDataURL) {
                            doc.addImage(logoDataURL, 'PNG', 10, 5, 50, 20); // Tambahkan logo (default atau diupload)
                        }
                    };

                    // Mulai dengan header di halaman pertama
                    addHeader();
                    let y = logoDataURL ? 30 : 10; // Adjust y berdasarkan ada logo atau tidak

                    // Set font ke Times New Roman (built-in 'times' di jsPDF)
                    doc.setFont('times', 'normal');
                    doc.setFontSize(16);
                    doc.setFont('times', 'bold');
                    doc.text(`Laporan Pekerjaan Mingguan - ${posisi}`, 10, y);
                    y += 10;

                    doc.setFontSize(12);
                    doc.setFont('times', 'normal');
                    doc.text(`Posisi: ${posisi}`, 10, y);
                    y += 7;
                    doc.text(`Periode Laporan: ${periode}`, 10, y);
                    y += 7;
                    doc.text(`Proyek: ${proyek}`, 10, y);
                    y += 10;

                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.text('Pendahuluan', 10, y);
                    y += 7;
                    doc.setFontSize(12);
                    doc.setFont('times', 'normal');
                    const pendahuluanLines = doc.splitTextToSize(pendahuluan, 180);
                    doc.text(pendahuluanLines, 10, y);
                    // y += (pendahuluanLines.length * 7) + 10; // Adjust based on line height

                    doc.addPage();
                    addHeader();
                    y = logoDataURL ? 30 : 10;
                    // Teks "Pekerjaan yang Telah Dilakukan" ditengah halaman
                    const pageWidth = doc.internal.pageSize.width;
                    const textWidth = doc.getStringUnitWidth('Pekerjaan yang Telah Dilakukan') * doc.getFontSize() / doc.internal.scaleFactor;
                    const textX = (pageWidth - textWidth) / 2; // Posisi tengah
                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.text('Pekerjaan yang Telah Dilakukan', textX, y);
                    y += 20; // Tambah jarak setelah judul

                    const pekerjaanSections = document.querySelectorAll('.pekerjaan-section');
                    pekerjaanSections.forEach((section, index) => {
                        const judul = section.querySelector('.judul-pekerjaan').value;
                        const tujuan = section.querySelector('.tujuan-pekerjaan').value;
                        const deskripsi = section.querySelector('.deskripsi-pekerjaan').value.split('\n').map(line => '• ' + line.trim()).join('\n');
                        const hasil = section.querySelector('.hasil-pekerjaan').value;

                        doc.setFontSize(13);
                        doc.setFont('times', 'bold');
                        doc.text(`2.${index + 1} ${judul}`, 10, y);
                        y += 7;

                        doc.setFontSize(12);
                        doc.setFont('times', 'bold');
                        doc.text('Tujuan:', 15, y); // Label bold
                        y += 7;
                        doc.setFont('times', 'normal');
                        const tujuanLines = doc.splitTextToSize(tujuan, 175);
                        doc.text(tujuanLines, 15, y); // Isi tanpa indent
                        y += (tujuanLines.length * 7) + 5;

                        doc.setFont('times', 'bold');
                        doc.text('Deskripsi Pekerjaan:', 15, y); // Label bold
                        y += 7;
                        doc.setFont('times', 'normal');
                        const deskripsiLines = doc.splitTextToSize(deskripsi, 175);
                        doc.text(deskripsiLines, 15, y); // Isi tanpa indent
                        y += (deskripsiLines.length * 7) + 5;

                        doc.setFont('times', 'bold');
                        doc.text('Hasil:', 15, y); // Label bold
                        y += 7;
                        doc.setFont('times', 'normal');
                        const hasilLines = doc.splitTextToSize(hasil, 175);
                        doc.text(hasilLines, 15, y); // Isi tanpa indent
                        y += (hasilLines.length * 7) + 10;

                        // if (y > 250) { // Jika mendekati akhir halaman, tambah page baru dengan header
                        //     doc.addPage();
                        //     addHeader();
                        //     y = logoDataURL ? 30 : 10;
                        // }
                        doc.addPage();
                        addHeader();
                        y = logoDataURL ? 30 : 10;
                    });

                    // if (y > 250) {
                    //     doc.addPage();
                    //     addHeader();
                    //     y = logoDataURL ? 30 : 10;
                    // }

                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.text('3. Kendala yang Dihadapi', 10, y);
                    y += 7;
                    doc.setFontSize(12);
                    doc.setFont('times', 'normal');
                    const kendalaLines = doc.splitTextToSize(kendala, 180);
                    doc.text(kendalaLines, 10, y);
                    y += (kendalaLines.length * 7) + 10;

                    if (y > 250) {
                        doc.addPage();
                        addHeader();
                        y = logoDataURL ? 30 : 10;
                    }

                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.text('4. Rencana Tindak Lanjut', 10, y);
                    y += 7;
                    doc.setFontSize(12);
                    doc.setFont('times', 'normal');
                    const rencanaLines = doc.splitTextToSize(rencana, 180);
                    doc.text(rencanaLines, 10, y);
                    y += (rencanaLines.length * 7) + 10;

                    if (y > 250) {
                        doc.addPage();
                        addHeader();
                        y = logoDataURL ? 30 : 10;
                    }

                    doc.setFontSize(14);
                    doc.setFont('times', 'bold');
                    doc.text('5. Kesimpulan', 10, y);
                    y += 7;
                    doc.setFontSize(12);
                    doc.setFont('times', 'normal');
                    const kesimpulanLines = doc.splitTextToSize(kesimpulan, 180);
                    doc.text(kesimpulanLines, 10, y);
                    y += (kesimpulanLines.length * 7) + 10;

                    // Lampiran Gambar
                    if (document.querySelectorAll('.gambar-section').length > 0) {
                        doc.addPage(); // Selalu buat halaman baru untuk lampiran
                        addHeader(); // Tambahkan header logo di halaman baru
                        y = logoDataURL ? 30 : 10; // Set posisi awal berdasarkan ada/tidaknya logo

                        // Teks "Lampiran Gambar" ditengah halaman
                        const pageWidth = doc.internal.pageSize.width;
                        const textWidth = doc.getStringUnitWidth('Lampiran Gambar') * doc.getFontSize() / doc.internal.scaleFactor;
                        const textX = (pageWidth - textWidth) / 2; // Posisi tengah
                        doc.setFontSize(14);
                        doc.setFont('times', 'bold');
                        doc.text('Lampiran Gambar', textX, y);
                        y += 20; // Tambah jarak setelah judul

                        const gambarSections = document.querySelectorAll('.gambar-section');
                        for (let i = 0; i < gambarSections.length; i++) {
                            if (y > 180) { // Jika mendekati akhir halaman, buat halaman baru
                                doc.addPage();
                                addHeader();
                                y = logoDataURL ? 30 : 10;
                                const pageWidth = doc.internal.pageSize.width;
                                const textWidth = doc.getStringUnitWidth('Lampiran Gambar') * doc.getFontSize() / doc.internal.scaleFactor;
                                const textX = (pageWidth - textWidth) / 2;
                                doc.text('Lampiran Gambar', textX, y); // Ulangi judul di halaman baru
                                y += 20;
                            }

                            const fileInput = gambarSections[i].querySelector('.gambar-file');
                            const keterangan = gambarSections[i].querySelector('.keterangan-gambar').value;

                            if (fileInput.files.length > 0) {
                                const file = fileInput.files[0];
                                const reader = new FileReader();
                                await new Promise((resolve) => {
                                    reader.onload = (e) => {
                                        doc.setFontSize(12);
                                        doc.setFont('times', 'bold');
                                        doc.text(`Gambar ${i + 1}: ${keterangan}`, 10, y);
                                        y += 7;
                                        // Ukuran gambar diatur di sini: 100 (lebar), 100 (tinggi)
                                        doc.addImage(e.target.result, 'JPEG', 10, y, 100, 100); 
                                        y += 110; // Jarak setelah gambar (sesuai tinggi gambar + margin)
                                        resolve();
                                    };
                                    reader.readAsDataURL(file);
                                });
                            }
                        }
                    }

                    saveData();
                    doc.save('laporan_pekerjaan.pdf');
                });
            });

            // Fungsi Generate DOCX (experimental)
            document.getElementById('generateDOCX').addEventListener('click', () => {
                alert('Fitur Generate DOCX masih experimental. Untuk saat ini, gunakan PDF. Jika ingin DOCX full, Anda bisa integrasikan docxtemplater dengan template DOCX yang diupload.');
            });
        };
    </script>
</body>
</html>