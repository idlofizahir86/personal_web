<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web JSON Handler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Input Data</h2>
        <div class="mb-3">
            <label for="message" class="form-label">Message</label>
            <input type="text" id="message" class="form-control">
        </div>
        <div class="mb-3">
            <label for="intent" class="form-label">Intent</label>
            <select id="intent" class="form-select"></select>
        </div>
        <button class="btn btn-primary" onclick="saveData()">Simpan</button>
        <button class="btn btn-success" onclick="downloadData()">Unduh JSON</button>
        <a href="add_intent.html" class="btn btn-info">Tambah Intent</a>
        
        <hr>
        <h2>Data Statistik</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Intent</th>
                    <th>Jumlah</th>
                </tr>
            </thead>
            <tbody id="dataStats"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAGTrcgg0bUGS8nS11uUsfU_5ymkNY_dZ8",
            authDomain: "reksata-dialog.firebaseapp.com",
            databaseURL: "https://reksata-dialog-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reksata-dialog",
            storageBucket: "reksata-dialog.appspot.com",
            messagingSenderId: "1048714287798",
            appId: "1:1048714287798:web:b183831c52549a0404e417"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.child = child;
        window.push = push;
        window.onValue = onValue;

        document.addEventListener("DOMContentLoaded", loadOptions);
        document.getElementById('message').addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                saveData();
            }
        });

        function loadOptions() {
            const dropdown = document.getElementById('intent');
            dropdown.innerHTML = '';
            get(ref(db, 'intents')).then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        let opt = document.createElement('option');
                        opt.value = childSnapshot.val();
                        opt.textContent = childSnapshot.val();
                        dropdown.appendChild(opt);
                    });
                    loadStats();
                }
            }).catch(error => console.error("Gagal memuat intent:", error));
        }

        function saveData() {
            let messageInput = document.getElementById('message');
            let message = messageInput.value;
            let intent = document.getElementById('intent').value;

            if (!message.trim()) {
                alert("Message tidak boleh kosong");
                return;
            }

            const dbRef = ref(db, 'messages/' + Date.now());
            set(dbRef, { intent, message }).then(() => {
                alert("Data berhasil disimpan!");
                messageInput.value = "";
            }).catch(error => console.error("Gagal menyimpan data:", error));
        }

        function loadStats() {
            get(ref(db, 'intents')).then(intentSnapshot => {
                if (!intentSnapshot.exists()) return;
                
                let stats = {};
                intentSnapshot.forEach(childSnapshot => {
                    let intent = childSnapshot.val();
                    stats[intent] = 0; 
                });

                get(ref(db, 'messages')).then(messageSnapshot => {
                    if (messageSnapshot.exists()) {
                        messageSnapshot.forEach(childSnapshot => {
                            let data = childSnapshot.val();
                            if (stats.hasOwnProperty(data.intent)) {
                                stats[data.intent]++;
                            }
                        });
                    }
                    updateStatsTable(stats);
                });
            }).catch(error => console.error("Gagal mengambil statistik:", error));
        }

        function updateStatsTable(stats) {
            let tableBody = document.getElementById('dataStats');
            tableBody.innerHTML = '';
            for (let intent in stats) {
                let row = `<tr><td>${intent}</td><td>${stats[intent]}</td></tr>`;
                tableBody.innerHTML += row;
            }
        }

        function downloadData() {
            get(ref(db, 'messages')).then(snapshot => {
                if (snapshot.exists()) {
                    let data = snapshot.val();
                    let blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    let a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = "dialog_data_new.json";
                    a.click();
                }
            }).catch(error => console.error("Gagal mengunduh data:", error));
        }

        onValue(ref(db, 'messages'), () => {
            loadStats();
        });
    </script>
</body>
</html>